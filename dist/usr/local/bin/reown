#!/bin/bash

# +---------------------------------------------------------------------+
# | WARNING: Do NOT edit this file directly or your changes will be     |
# | lost. If you need to change this file, you must incorporate your    |
# | changes into the AutomateIt project that created it. If you don't   |
# | know what this means, please talk to your system administrator.     |
# +---------------------------------------------------------------------+

# SUMMARY: Reown shared files and directories to correct group ownerships.
# ARGUMENTS: Any arguments will cause this to run in quiet mode.

# Parse arguments
if [[ $1 ]]; then
    VERBOSE=n
else
    VERBOSE=y
    echo "# reowning shared files and directories"
fi

# There can be only one
# FIXME why does "1" below cause this to always think there's something running?!
if [ `pgrep reown | wc -l` -gt 2 ]; then
   if [[ $VERBOSE = y ]]; then
       echo "Already running"
   fi
   exit 2
fi

# Rerun command as root or through sudo
if ! [[ 0 == $UID ]]; then
    exec sudo $0 $1
fi

# Execute commands at low priority
nicely () {
    #ionice -c 2 -n 7 -- nice -n 19 -- "$@"
    nice -n 19 -- "$@"
}

# Commands to execute
## Traditional UNIX-based permissions
### nicely chown -R bridgepdx:bridgepdx "/var/www/bridgepdx"*
### nicely find "/var/www/bridgepdx"* -type d -exec chmod g+s {} \;
### nicely chmod -R g+rwX "/var/www/bridgepdx"*

## Contemporary ACL-based permissions
nicely setfacl -R -d -m g:bridgepdx:rwX "/var/www/bridgepdx"*
nicely setfacl -R    -m g:bridgepdx:rwX "/var/www/bridgepdx"*
nicely find "/var/www/bridgepdx_ocw"* -type d -exec chown bridgepdx:bridgepdx {} \;
