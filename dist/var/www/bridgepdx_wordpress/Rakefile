# +---------------------------------------------------------------------+
# | WARNING: Do NOT edit this file directly or your changes will be     |
# | lost. If you need to change this file, you must incorporate your    |
# | changes into the AutomateIt project that created it. If you don't   |
# | know what this means, please talk to your system administrator.     |
# +---------------------------------------------------------------------+

# Tasks for manipulating the OpenSourceBridge WordPress instance

verbose(true) unless Rake.application.options.silent

task :default => :help

task :help do
  puts <<-HERE
OpenSourceBridge WordPress rake tasks:
- dump : Dump database to a FILE
- restore : Restore database from a FILE
- rehome : Alter database's home paths
- credentials : Display database credentials
  HERE
end

desc "Rehome database to URL"
task :rehome do
  url = ENV['URL'] or raise ArgumentError, 'URL environmental variable not specified'
  sh %{echo "update wp_options set option_value='#{url}' where option_name='siteurl' or option_name='home'" | mysql #{credentials_for_cli}}, :verbose => true
end

desc "Dump database to a FILE"
task :dump do
  sh "mysqldump --add-locks --create-options --disable-keys --extended-insert --quick --set-charset #{credentials_for_cli} > #{sql_filename}.tmp && mv #{sql_filename}.tmp #{sql_filename}"
end

desc "Restore database from a FILE"
task :restore do
  sh "echo 'CREATE DATABASE IF NOT EXISTS #{credentials.database}' | mysql #{credentials_for_cli :database => false}"
  sh "mysql #{credentials_for_cli} < #{sql_filename}", :verbose => true
end

desc "Display database credentials"
task :credentials do
  p credentials_for_cli
end

def credentials_for_cli(opts={})
  result = "--user=#{credentials.user} --password=#{credentials.password}"
  result << " --host=#{credentials.host}" if credentials.host
  result << " #{credentials.database}" unless opts[:database] == false
  return result
end

def credentials
  return @@credentials ||= Credentials.import
end

def sql_filename
  return ENV['FILE'] || 'bridgepdx_wordpress.sql'
end

# = Credentials
#
# Import the WordPress database configuration
class Credentials < Struct.new(:user, :password, :database, :host)
  def self.import(filename='wp-config.php')
    r = self.new
    open(filename) do |h|
      data = h.read
      r.user     = self.extract(data, 'DB_USER')
      r.password = self.extract(data, 'DB_PASSWORD')
      r.database = self.extract(data, 'DB_NAME')
      r.host     = self.extract(data, 'DB_HOST')
    end
    return r
  end

  def self.extract(data, key)
    return data[%r{^define\('#{key}', '([^']+)'\)}, 1]
  end
end
