# +---------------------------------------------------------------------+
# | WARNING: Do NOT edit this file directly or your changes will be     |
# | lost. If you need to change this file, you must incorporate your    |
# | changes into the AutomateIt project that created it. If you don't   |
# | know what this means, please talk to your system administrator.     |
# +---------------------------------------------------------------------+

<VirtualHost *:80>
    # Site
    DocumentRoot /var/www/bridgepdx_wordpress
    ServerName bridgepdx.org
    ServerAlias www.bridgepdx.org bridgepdx bridgepdx.pragmaticraft.com opensourcebridge.org www.opensourcebridge.org
    RewriteEngine On

    # Logs
    ErrorLog /var/log/apache2/bridgepdx_wordpress.error.log
    TransferLog /var/log/apache2/bridgepdx_wordpress.access.log
    CustomLog /var/log/apache2/bridgepdx_wordpress.referer.log "%{Referer}i -> %U"

    # Canonical hostname
    RewriteCond %{HTTP_HOST} !^opensourcebridge.org [NC]
    RewriteCond %{HTTP_HOST} !^$
    RewriteRule ^/(.*) http://opensourcebridge.org/$1 [L,R]

    # WordPress's category, tag and top-level date-based article names
    RedirectPermanent /category /blog/category
    RedirectPermanent /tag /blog/tag
    RewriteRule ^(2\d{3}/\d+/.+) /blog/$1 [R=301,L]

    # Common stylesheets and images
    Alias /common /var/www/bridgepdx_common

    # Rails system directory, e.g., photos
    Alias /system /var/www/bridgepdx_ocw/shared/system

    # Planning wiki
    Alias /planning /var/www/bridgepdx_planning
    
    # Stats
    Alias /stats /var/www/bridgepdx_stats

    ### Unified MediaWiki
    # Redirect old pages
    RewriteRule ^/(\d{4})/wiki(/.*)?$ /wiki/$1$2 [L,R]
    # Redirect base requests
    RewriteRule ^/wiki/?$ /wiki/Main_Page [R]
    # Redirect year requests
    RewriteRule ^/wiki/(\d{4})/?$ /wiki/$1/Main_Page [R]
    # Render pages
    RewriteRule ^/wiki/(.+)$ /var/www/bridgepdx_wiki/index.php?title=$1 [L,QSA]
    # Serve API requests
    RewriteRule ^/wiki-raw/(.+)$ /var/www/bridgepdx_wiki/$1 [L,QSA]

    # Proxy
    ProxyRequests off
    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

    # OCW
<% for frag in %w[
admin
browser_session
browser_sessions
events
images
javascripts
login
logout
manage
proposals
rooms
schedule
schedule_items
selector_votes
session
session_types
sessions
stylesheets
themes
tracks
users
] %>
    ProxyPassMatch ^(/<%= frag %>\..*)$  http://ocw.opensourcebridge.org$1
    ProxyPass /<%= frag %>  http://ocw.opensourcebridge.org/<%= frag %>
    <Location /<%= frag %>>
      ProxyPassReverse http://ocw.opensourcebridge.org/<%= frag %>
    </Location>
<% end %>
</VirtualHost>
