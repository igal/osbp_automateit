# +---------------------------------------------------------------------+
# | WARNING: Do NOT edit this file directly or your changes will be     |
# | lost. If you need to change this file, you must incorporate your    |
# | changes into the AutomateIt project that created it. If you don't   |
# | know what this means, please talk to your system administrator.     |
# +---------------------------------------------------------------------+

<VirtualHost *:80>
    # Site
    DocumentRoot /var/www/bridgepdx_wordpress
    ServerName bridgepdx.org
    ServerAlias www.bridgepdx.org bridgepdx bridgepdx.pragmaticraft.com opensourcebridge.org www.opensourcebridge.org
    RewriteEngine On

    # Logs
    ErrorLog /var/log/apache2/bridgepdx_wordpress.error.log
    TransferLog /var/log/apache2/bridgepdx_wordpress.access.log
    CustomLog /var/log/apache2/bridgepdx_wordpress.referer.log "%{Referer}i -> %U"

    # Canonical hostname
    RewriteCond %{HTTP_HOST} !^opensourcebridge.org [NC]
    RewriteCond %{HTTP_HOST} !^$
    RewriteRule ^/(.*) http://opensourcebridge.org/$1 [L,R]

    # WordPress's category, tag and top-level date-based article names
    RedirectPermanent /category /blog/category
    RedirectPermanent /tag /blog/tag
    RewriteRule ^(2\d{3}/\d+/.+) /blog/$1 [R=301,L]

    # Common stylesheets and images
    Alias /common /var/www/bridgepdx_common

    # Rails system directory, e.g., photos
    Alias /system /var/www/bridgepdx_ocw/shared/system

    # Planning wiki
    Alias /planning /var/www/bridgepdx_planning
    
    # Stats
    Alias /stats /var/www/bridgepdx_stats

    # Attendee wiki redirect
    RewriteRule ^/w(/.*)?$ /2010/w$1 [L,R]
    RewriteRule ^/wiki(/.*)?$ /2010/wiki$1 [L,R]

    # Attendee wiki's scripts
    Alias /2009/w /var/www/bridgepdx_wiki_2009
    Alias /2010/w /var/www/bridgepdx_wiki_2010

    # Attendee wiki's pages
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^/2009/wiki(/.*)?$ /var/www/bridgepdx_wiki_2009/index.php?title=$1 [L,QSA]
    RewriteRule ^/2010/wiki(/.*)?$ /var/www/bridgepdx_wiki_2010/index.php?title=$1 [L,QSA]

    # Proxy
    ProxyRequests off
    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

    # OCW
<% for frag in %w[
admin
browser_session
browser_sessions
events
images
javascripts
login
logout
manage
proposals
rooms
schedule
schedule_items
session
session_types
sessions
stylesheets
themes
tracks
users
] %>
    ProxyPassMatch ^(/<%= frag %>\..*)$  http://ocw.opensourcebridge.org$1
    ProxyPass /<%= frag %>  http://ocw.opensourcebridge.org/<%= frag %>
    <Location /<%= frag %>>
      ProxyPassReverse http://ocw.opensourcebridge.org/<%= frag %>
    </Location>
<% end %>
</VirtualHost>
